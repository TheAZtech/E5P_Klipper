# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication/USART.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.

######################################################################
##                       FLUIDD MUST HAVES                          ##
###################################################################### 

[virtual_sdcard]
path: ~/gcode_files

[display_status]

######################################################################
##                      PAUSE / RESUME / CANCEL                     ##
######################################################################

[pause_resume]

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}  
  RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  CANCEL_PRINT_BASE

  G91                 ; Relative positioning
  G1 E-2 Z10 F2700    ; Retract and lift Z
  G90                 ; Absolute positioning

  G1 X180 Y350 F9001  ; end home X Y axis

  M104 S0             ; turn off temperature
  M140 S0             ; turn off heatbed
  M107                ; turn off fans

  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
  SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
  SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
  SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1           ; disable all motors but Z

######################################################################
##                      START END GCODE MACROS                      ##
######################################################################

#The following Macro is used to replace slicer starting gcode.
#In your slicer replace starting gcode with START_PRINT

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(205)|float %}
    
    G90 ; use absolute coordinates
    M83 ; extruder relative mode
    
    #SET_GCODE_OFFSET Z=-0.90 # Reset the G-Code Z offset (adjust Z offset if needed)
    
    M104 S{EXTRUDER_TEMP}   ; set extruder temp 
    M140 S{BED_TEMP}        ; set bed temp
    M109 S{EXTRUDER_TEMP}   ; wait for extruder temp
    M190 S{BED_TEMP}        ; wait for extruder temp
    
    G28                     ; Home the printer
    
    G92 E0                          ; reset extruder postion
    G1 Z2 F5000                     ; lift nozzle
    G1 X10 Y20 Z0.28 F9001          ; Move to start position
    G1 X10 Y200.0 Z0.28 F1500.0 E15 ; Draw the first line
    G1 X11 Y200.0 Z0.28 F9001       ; Move to side a little
    G1 X11 Y20 Z0.28 F1500.0 E15    ; Draw the second line
    G92 E0                          ; reset extruder position
    G1 Z2 F5000                     ; lift nozzle

#The following Macro is used to replace the ending gcode in your slicer
#replace the end gcode in your slicer with END_PRINT

[gcode_macro END_PRINT]
gcode:
    G91                 ; Relative positioning
    G1 E-2 Z10 F2700    ; Retract and lift Z
    G90                 ; Absolute positioning

    G1 X180 Y350 F9001  ; end home X Y axis

    M104 S0             ; turn off temperature
    M140 S0             ; turn off heatbed
    M107                ; turn off fans

    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1     ; disable all motors but Z

######################################################################
##                    PRESSURE ADVANCE GCODE MACROS                 ##
######################################################################

[gcode_macro HATCHBOX_PLA_BLACK]
gcode:
  SET_PRESSURE_ADVANCE EXTRUDER=extruder ADVANCE=0.08

[gcode_macro HATCHBOX_PLA_WHITE]
gcode:
  SET_PRESSURE_ADVANCE EXTRUDER=extruder ADVANCE=0.08

[gcode_macro OVERTURE_PLA_PURPLE]
gcode:
  SET_PRESSURE_ADVANCE EXTRUDER=extruder ADVANCE=0.07625


######################################################################
##                          OTHER GCODE MACROS                      ##
######################################################################

#[gcode_macro EXTRUDER_CALIBRATE]

[gcode_macro ACTIVATE_ZED]
gcode:
  SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1

######################################################################
##                          STEPPER DRIVERS                         ##     
######################################################################

[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC0
position_endstop: 350
position_max: 350
homing_speed: 100

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
#run_current: 0.580
run_current: 0.745
#hold_current: 0.500
stealthchop_threshold: 999999

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC1
position_endstop: 350
position_max: 350
homing_speed: 100

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.580
#hold_current: 0.500
stealthchop_threshold: 999999

[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 4
# endstop_pin: ^PC2
# position_endstop: 0.0
endstop_pin: probe:z_virtual_endstop
position_max: 400
position_min: -4
homing_speed: 10.0

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
#run_current: 0.580 #original setting
run_current: 0.9
#hold_current: 0.500
stealthchop_threshold: 999999

[extruder]
step_pin: PB3
dir_pin: !PB4
enable_pin: !PD1
microsteps: 16
rotation_distance: 23.312
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
#control = pid
#pid_kp = 28.906
#pid_ki = 2.007
#pid_kd = 104.060
min_temp: 0
max_temp: 260
max_extrude_only_distance: 200
#max_extrude_cross_section: 1 # added in atempt to fix issue with cura 
pressure_advance: .08
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
run_current: 0.650
#hold_current: 0.500
stealthchop_threshold: 999999

[safe_z_home]
home_xy_position: 218.1, 186.5
speed: 100
z_hop: 10
z_hop_speed: 20

######################################################################
##                            BL Touch                              ##
######################################################################

[bltouch]
sensor_pin: ^PC14
control_pin: PA1
x_offset: -46
y_offset: -9
#z_offset: 1.0
speed: 3.0
probe_with_touch_mode: True
stow_on_each_sample: False
#pin_up_touch_mode_reports_triggered: True

######################################################################
##                         FILAMENT RUNOUT                          ##
######################################################################

[filament_switch_sensor filament_sensor]
switch_pin: PC15

######################################################################
##                        FIRMWARE RETRACTION                       ##
######################################################################

[firmware_retraction]
retract_length: 0.5
retract_speed: 40

######################################################################
##                       BED SCREW LOCATIONS                        ##
######################################################################

[bed_screws]
screw1: 68,56
screw2: 68,314
screw3: 348,314
screw4: 348,56

######################################################################
##                          BED SETTINGS                            ##
######################################################################

[heater_bed]
heater_pin: PC9
#sensor_type: ATC Semitec 104GT-2 #Stock File Setting
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
#control = pid
#pid_kp = 68.107
#pid_ki = 0.875
#pid_kd = 1325.524
min_temp: 0
max_temp: 130

######################################################################
##                         INPUT SHAPER                             ##
######################################################################

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points: 180,180,20

#[input_shaper]
#shaper_freq_x: 101.2
#shaper_type_x: mzv
#shaper_freq_y: 57.2
#shaper_type_y: ei

######################################################################
##                             BED MESH                             ##
######################################################################

#[bed_mesh]
#speed: 120
#horizontal_move_z: 5
#mesh_min: 10, 10
#mesh_max: 190, 220
#probe_count: 5,5

######################################################################
##                            FAN SETTINGS                          ##
######################################################################

[heater_fan controller_fan]
pin: PB15
heater: heater_bed
heater_temp: 45.0

[heater_fan parts_cooling_fan]
pin: PC7

[fan]
pin: PC6

######################################################################
##                               MCU                                ##
######################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_3F003D001850344D30363620-if00
# serial: /dev/ttyAMA0
# restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp
min_temp: 10
max_temp: 100

######################################################################
##                          KINEMATICS                              ##
######################################################################

[printer]
kinematics: cartesian
max_velocity: 100
max_accel: 1000
max_accel_to_decel: 500
max_z_velocity: 10
max_z_accel: 10
square_corner_velocity: 5.0

######################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PD6, EXP1_10=<5V>

######################################################################
##                    TEMPERATURE SENSORS                           ##
######################################################################



######################################################################
#  BigTreeTech TFT TouchScreen emulated 12864 mode
######################################################################

#[display]
#lcd_type: emulated_st7920
#spi_software_miso_pin: PD8 # status led, Virtual MISO
#spi_software_mosi_pin: PD6
#spi_software_sclk_pin: PB9
#en_pin: PB8
#encoder_pins: ^PA10, ^PA9
#click_pin: ^!PA15

#[output_pin beeper]
#pin: PB5

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 30.362
#*# pid_ki = 2.381
#*# pid_kd = 96.780
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.594
#*# pid_ki = 0.735
#*# pid_kd = 1508.347
#*#
#*# [bltouch]
#*# z_offset = 0.964
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 56.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 39.0
